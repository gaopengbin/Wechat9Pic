# 实施计划

- [x] 1. 扩展类型定义


  - 添加Layer、TransformConfig、ShadowConfig接口
  - 添加LayerErrorType枚举
  - 定义参数约束常量CONSTRAINTS
  - _需求：所有需求的基础_







- [ ] 2. 实现参数约束工具函数
  - [x] 2.1 实现clampScale函数（10-300%范围）


    - _需求：3.2_
  - [ ] 2.2 编写属性测试：缩放范围约束
    - **属性 7：缩放范围约束**

    - **验证：需求 3.2**

  - [ ] 2.3 实现clampRotation函数（-180到180度）
    - _需求：3.3_

  - [ ] 2.4 编写属性测试：旋转范围约束
    - **属性 8：旋转范围约束**

    - **验证：需求 3.3**

  - [ ] 2.5 实现clampShadowParams函数（模糊、偏移、透明度）
    - _需求：4.2, 4.3, 4.4_






  - [x] 2.6 编写属性测试：阴影参数范围约束

    - **属性 10：阴影参数范围约束**

    - **验证：需求 4.2, 4.3, 4.4**

  - [ ] 2.7 实现clampOpacity函数（0-100%）
    - _需求：6.1_

  - [ ] 2.8 编写属性测试：透明度范围约束
    - **属性 14：透明度范围约束**
    - **验证：需求 6.1**





  - [x] 2.9 实现clampBorderWidth函数（1-10px）

    - _需求：1.4_
  - [x] 2.10 编写属性测试：边框宽度范围约束

    - **属性 3：边框宽度范围约束**

    - **验证：需求 1.4**


- [x] 3. 实现九宫格底图生成器（GridGenerator）

  - [ ] 3.1 实现cropToSquare函数，将图片裁剪为正方形
    - _需求：1.3_

  - [ ] 3.2 编写属性测试：图片裁剪正方形保持
    - **属性 2：图片裁剪正方形保持**

    - **验证：需求 1.3**






  - [ ] 3.3 实现generate函数，生成1080×1080九宫格底图
    - 将9张图片按3×3排列
    - 添加边框
    - _需求：1.1, 1.2_

  - [ ] 3.4 编写属性测试：九宫格底图尺寸一致性
    - **属性 1：九宫格底图尺寸一致性**
    - **验证：需求 1.1**

  - [ ] 3.5 编写单元测试
    - 测试边框颜色选项
    - 测试不同尺寸图片输入




    - _需求：1.5_

- [ ] 4. 实现图层管理器（LayerManager）
  - [ ] 4.1 实现addLayer函数
    - 检查图层数量限制（最多5个）
    - _需求：5.1_
  - [ ] 4.2 编写属性测试：图层数量限制
    - **属性 11：图层数量限制**
    - **验证：需求 5.1**
  - [ ] 4.3 实现removeLayer函数
    - _需求：5.4_
  - [ ] 4.4 编写属性测试：图层删除完整性
    - **属性 12：图层删除完整性**
    - **验证：需求 5.4**
  - [ ] 4.5 实现reorderLayers函数
    - _需求：5.5_
  - [ ] 4.6 编写属性测试：图层顺序调整一致性
    - **属性 13：图层顺序调整一致性**
    - **验证：需求 5.5**


  - [x] 4.7 实现updateLayer函数

    - 应用参数约束
    - _需求：3.1, 3.2, 3.3, 4.1-4.5, 6.1_
  - [ ] 4.8 编写属性测试：主体位置无边界限制
    - **属性 6：主体位置无边界限制**



    - **验证：需求 3.1**

- [x] 5. 集成AI抠图服务（MattingService）


  - [ ] 5.1 安装@imgly/background-removal库
    - _需求：2.1_
  - [ ] 5.2 实现MattingService类
    - 实现loadModel函数
    - 实现removeBackground函数

    - 实现错误处理和超时逻辑


    - _需求：2.1, 2.2, 2.5_










  - [x] 5.3 编写属性测试：抠图输出格式有效性

    - **属性 4：抠图输出格式有效性**


    - **验证：需求 2.2**

  - [x] 5.4 编写属性测试：抠图错误处理完整性


    - **属性 5：抠图错误处理完整性**

    - **验证：需求 2.5**
  - [x] 5.5 编写单元测试


    - 测试模型加载
    - 测试超时处理

    - _需求：2.1, 2.5_









- [x] 6. 实现Canvas渲染器（LayerRenderer）


  - [x] 6.1 实现applyTransform函数




    - 应用位置、缩放、旋转变换
    - _需求：3.1, 3.2, 3.3_








  - [ ] 6.2 实现drawShadow函数
    - 绘制高斯模糊阴影


    - _需求：4.1, 4.2, 4.3, 4.4, 4.5_




  - [ ] 6.3 实现renderLayer函数
    - 渲染单个图层（含变换和阴影）









    - 应用透明度
    - _需求：6.1, 6.5_
  - [ ] 6.4 实现render函数
    - 按zIndex顺序渲染所有图层
    - _需求：7.2_
  - [ ] 6.5 编写属性测试：导出图层顺序正确性
    - **属性 16：导出图层顺序正确性**
    - **验证：需求 7.2**
  - [ ] 6.6 编写单元测试
    - 测试变换计算
    - 测试阴影绘制
    - _需求：3.1, 4.1_

- [ ] 7. 实现导出服务扩展
  - [ ] 7.1 实现图层合成导出
    - 合成所有图层为1080×1080图片
    - 裁剪超出边界的部分
    - _需求：7.1, 7.4_
  - [ ] 7.2 编写属性测试：导出裁剪正方形保持
    - **属性 9：导出裁剪正方形保持**
    - **验证：需求 3.5, 7.4**
  - [ ] 7.3 实现JPEG质量控制（≥90%）
    - _需求：7.3_
  - [ ] 7.4 编写属性测试：导出质量保持
    - **属性 17：导出质量保持**



    - **验证：需求 7.3**
  - [ ] 7.5 实现generatePreview函数
    - 使用与导出相同的渲染逻辑
    - _需求：8.5_
  - [ ] 7.6 编写属性测试：预览与导出一致性
    - **属性 18：预览与导出一致性**
    - **验证：需求 8.5**
  - [ ] 7.7 编写属性测试：透明度导出保持
    - **属性 15：透明度导出保持**
    - **验证：需求 6.5**

- [ ] 8. 检查点 - 确保所有核心服务测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 9. 实现图层编辑器UI组件
  - [ ] 9.1 创建LayerEditor主组件
    - 显示画布预览区域
    - 集成图层面板
    - _需求：8.1, 8.2_
  - [ ] 9.2 实现SubjectUploader组件
    - 上传主体图片
    - 显示抠图进度
    - _需求：2.1, 2.5_
  - [ ] 9.3 实现LayerPanel组件
    - 显示图层列表
    - 支持拖拽排序
    - 支持选择、删除图层
    - _需求：5.2, 5.3, 5.4_
  - [ ] 9.4 实现TransformControls组件
    - 位置拖拽控制
    - 缩放滑块（10-300%）
    - 旋转滑块（-180到180度）
    - _需求：3.1, 3.2, 3.3_
  - [ ] 9.5 实现ShadowControls组件
    - 阴影开关
    - 模糊度滑块（0-30px）
    - 偏移滑块（-50到50px）
    - 透明度滑块（0-100%）
    - 颜色选择器
    - _需求：4.1, 4.2, 4.3, 4.4, 4.5_
  - [ ] 9.6 实现OpacityControl组件
    - 透明度滑块（0-100%）
    - _需求：6.1_
  - [ ] 9.7 编写组件单元测试
    - 测试图层列表显示
    - 测试滑块范围限制
    - _需求：5.2, 3.2, 4.2_

- [ ] 10. 实现底图配置UI
  - [ ] 10.1 创建GridConfigPanel组件
    - 边框宽度滑块（1-10px）
    - 边框颜色选择器（白色、黑色、自定义）
    - _需求：1.4, 1.5_
  - [ ] 10.2 编写组件单元测试
    - 测试边框配置选项
    - _需求：1.4, 1.5_

- [ ] 11. 实现简易橡皮擦工具
  - [ ] 11.1 创建EraserTool组件
    - 画笔大小调节
    - 橡皮擦/恢复模式切换
    - _需求：2.4_
  - [ ] 11.2 编写单元测试
    - 测试橡皮擦功能
    - _需求：2.4_

- [ ] 12. 实现全屏预览功能
  - [ ] 12.1 创建FullscreenPreview组件
    - 全屏显示最终效果
    - 隐藏编辑控件
    - 退出按钮
    - _需求：8.2, 8.3, 8.4_
  - [ ] 12.2 编写组件单元测试
    - 测试全屏模式切换
    - _需求：8.2, 8.3, 8.4_

- [ ] 13. 集成到主应用
  - [ ] 13.1 在App.tsx中添加3D效果模式入口
    - 添加模式切换按钮
    - 集成LayerEditor组件
    - _需求：所有需求_
  - [ ] 13.2 实现模式切换逻辑
    - 普通模式 ↔ 3D效果模式
    - _需求：所有需求_
  - [ ] 13.3 编写集成测试
    - 测试完整工作流
    - _需求：所有需求_

- [ ] 14. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
